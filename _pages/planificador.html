---
layout: default
title: Planificador de la Carrera de Enseñanza de la Matemática de la UNED
permalink: /planificador/
---

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chosen Palette: Slate & Amber -->
<!-- Application Structure Plan: Se diseñó una aplicación de página única con una estructura de navegación por pestañas para separar las funcionalidades clave: "Mi Avance" (el panel de control principal con selección de cursos y progreso de credenciales), "Malla Curricular" (una vista visual e interactiva del plan de estudios) y "Cursos Disponibles" (una herramienta proactiva que muestra qué matricular a continuación). Esta estructura orientada a tareas permite al usuario responder rápidamente a sus preguntas más comunes ("¿cómo voy?", "¿cuál es el plan completo?", "¿qué sigue?") de una manera intuitiva y sin salir de la página, centralizando la información que antes estaba dispersa. -->
<!-- Visualization & Content Choices: 
    - Progreso General: Goal: Informar. Viz: Gráfico de dona (Chart.js) para mostrar créditos aprobados vs. pendientes, y tarjetas de estadísticas. Interaction: Actualización en tiempo real al marcar cursos. Justification: Ofrece un resumen visual inmediato del avance.
    - Malla Curricular: Goal: Organizar/Explorar. Viz: Diagrama de bloques con tarjetas de cursos (HTML/CSS con Tailwind Grid). Interaction: Clic en cursos para ver detalles en un modal, con codificación por colores (aprobado, disponible, bloqueado). Justification: Mucho más intuitivo que las listas para entender dependencias y planificar a futuro.
    - Credenciales: Goal: Informar. Viz: Listas con barras de progreso (HTML/CSS). Interaction: Clic para ver desglose de requisitos. Justification: Automatiza el seguimiento manual, un punto de dolor clave.
    - Cursos Disponibles: Goal: Decidir. Viz: Lista filtrable de tarjetas de cursos. Interaction: Filtros por periodo académico. Justification: Resuelve la pregunta más crítica del estudiante de manera directa y eficiente.
    - Library/Method: Vanilla JS para toda la lógica, Tailwind para el diseño, Chart.js para el gráfico de progreso. -->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
<style>
    :root {
        --color-primary: #1e293b; 
        --color-secondary: #475569;
        --color-accent: #f59e0b; 
        --color-background: #f1f5f9;
        --color-surface: #ffffff;
        --color-text-primary: #0f172a;
        --color-text-secondary: #475569;
        --status-approved: #22c55e;
        --status-available: #3b82f6;
        --status-locked: #64748b;
    }
    body {
        background-color: var(--color-background);
        color: var(--color-text-primary);
        font-family: 'Inter', sans-serif;
    }
    .tab-active {
        border-color: var(--color-accent);
        color: var(--color-primary);
        font-weight: 600;
    }
    .course-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .course-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .modal-backdrop {
        transition: opacity 0.3s ease;
    }
    .modal-content {
        transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .progress-bar-fill {
        transition: width 0.5s ease-in-out;
    }
</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<div id="app" class="container mx-auto p-4 md:p-8">
    
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-bold text-slate-800">Asistente Académico</h1>
        <p class="text-slate-600 mt-2">Enseñanza de la Matemática - UNED</p>
    </header>

    <main id="main-content" class="bg-white rounded-xl shadow-lg p-6 md:p-8">
        
        <div id="setup-section" class="mb-8">
            <label for="plan-select" class="block text-lg font-semibold text-slate-700 mb-2">1. Seleccione su Plan de Estudios:</label>
            <select id="plan-select" class="w-full max-w-md p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition">
            </select>
        </div>

        <div id="app-body" class="hidden">
            <div class="border-b border-slate-200 mb-6">
                <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                    <button data-tab="avance" class="tab-btn tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Mi Avance</button>
                    <button data-tab="malla" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 font-medium text-sm">Malla Curricular</button>
                    <button data-tab="disponibles" class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 font-medium text-sm">Cursos Disponibles</button>
                </nav>
            </div>

            <div id="tab-content">
                <div id="avance-tab" class="tab-pane">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Panel de Avance</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
                        <div class="lg:col-span-1 flex flex-col items-center justify-center p-6 bg-slate-50 rounded-lg">
                                <h3 class="text-lg font-semibold text-slate-700 mb-4">Progreso de Créditos</h3>
                            <div class="chart-container w-full max-w-xs mx-auto h-64">
                                <canvas id="credits-chart"></canvas>
                            </div>
                        </div>
                        <div class="lg:col-span-2">
                            <h3 class="text-lg font-semibold text-slate-700 mb-4">Estadísticas Clave</h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div class="bg-slate-100 p-4 rounded-lg text-center">
                                    <div id="approved-courses-count" class="text-3xl font-bold text-green-600">0</div>
                                    <div class="text-sm text-slate-600">Cursos Aprobados</div>
                                </div>
                                <div class="bg-slate-100 p-4 rounded-lg text-center">
                                    <div id="approved-credits-count" class="text-3xl font-bold text-green-600">0</div>
                                    <div class="text-sm text-slate-600">Créditos Ganados</div>
                                </div>
                                <div class="bg-slate-100 p-4 rounded-lg text-center">
                                    <div id="total-credits" class="text-3xl font-bold text-slate-800">0</div>
                                    <div class="text-sm text-slate-600">Créditos del Plan</div>
                                </div>
                            </div>
                            <div class="mt-6">
                                <h3 class="text-lg font-semibold text-slate-700 mb-4">Progreso de Credenciales</h3>
                                <div id="credentials-progress" class="space-y-4"></div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center mt-8 mb-4">
                        <h3 class="text-xl font-semibold text-slate-800">2. Marque los cursos que ha aprobado:</h3>
                        <button id="reset-button" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm font-medium transition-colors">
                            Volver a empezar
                        </button>
                    </div>
                    <div id="courses-checklist" class="space-y-6"></div>
                </div>
                
                <div id="malla-tab" class="tab-pane hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Malla Curricular Interactiva</h2>
                        <p class="text-slate-600 mb-6">Haga clic en un curso para ver sus detalles, prerrequisitos y qué cursos desbloquea.</p>
                    <div class="flex flex-wrap gap-2 mb-6">
                        <div class="flex items-center"><span class="w-4 h-4 bg-green-500 rounded-full mr-2"></span>Aprobado</div>
                        <div class="flex items-center"><span class="w-4 h-4 bg-blue-500 rounded-full mr-2"></span>Disponible</div>
                        <div class="flex items-center"><span class="w-4 h-4 bg-slate-500 rounded-full mr-2"></span>Bloqueado</div>
                    </div>
                    <div id="curriculum-map" class="space-y-8"></div>
                </div>

                <div id="disponibles-tab" class="tab-pane hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Asistente de Matrícula</h2>
                    <p class="text-slate-600 mb-6">Estos son los cursos que puede matricular según su avance. Filtre por periodo para planificar.</p>
                    <div class="mb-6">
                        <label for="period-filter" class="font-semibold text-slate-700">Filtrar por periodo de oferta:</label>
                        <div id="period-filter" class="flex flex-wrap gap-2 mt-2">
                            <button data-period="all" class="period-btn bg-amber-500 text-white px-4 py-2 rounded-full text-sm">Todos</button>
                            <button data-period="q1" class="period-btn bg-slate-200 text-slate-700 px-4 py-2 rounded-full text-sm">I Cuatrimestre</button>
                            <button data-period="q2" class="period-btn bg-slate-200 text-slate-700 px-4 py-2 rounded-full text-sm">II Cuatrimestre</button>
                            <button data-period="q3" class="period-btn bg-slate-200 text-slate-700 px-4 py-2 rounded-full text-sm">III Cuatrimestre</button>
                            <button data-period="s1" class="period-btn bg-slate-200 text-slate-700 px-4 py-2 rounded-full text-sm">I Semestre</button>
                            <button data-period="s2" class="period-btn bg-slate-200 text-slate-700 px-4 py-2 rounded-full text-sm">II Semestre</button>
                        </div>
                    </div>
                    <div id="available-courses-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="course-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-backdrop">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content transform scale-95 opacity-0">
        <div class="p-6 md:p-8">
            <div class="flex justify-between items-start">
                <div>
                    <h3 id="modal-course-name" class="text-2xl font-bold text-slate-800"></h3>
                    <p id="modal-course-code" class="text-sm text-slate-500"></p>
                </div>
                <button id="modal-close-btn" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div class="mt-6 border-t pt-6 grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div>
                    <div class="text-sm text-slate-500">Créditos</div>
                    <div id="modal-course-credits" class="text-xl font-semibold"></div>
                </div>
                <div>
                    <div class="text-sm text-slate-500">Nivel</div>
                    <div id="modal-course-level" class="text-xl font-semibold"></div>
                </div>
                    <div>
                    <div class="text-sm text-slate-500">Categorías</div>
                    <div id="modal-course-categories" class="text-sm font-semibold"></div>
                </div>
            </div>

            <div class="mt-6">
                <h4 class="font-semibold text-slate-700 mb-3">Disponibilidad</h4>
                <p id="modal-course-availability" class="text-slate-600"></p>
            </div>

            <div class="mt-6">
                <h4 class="font-semibold text-slate-700 mb-3">Prerrequisitos (necesita aprobar):</h4>
                <ul id="modal-course-prerequisites" class="list-disc list-inside space-y-1 text-slate-600"></ul>
            </div>

            <div class="mt-6">
                <h4 class="font-semibold text-slate-700 mb-3">Desbloquea los siguientes cursos:</h4>
                <ul id="modal-course-unlocks" class="list-disc list-inside space-y-1 text-slate-600"></ul>
            </div>
        </div>
    </div>
</div>

<div id="credential-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-backdrop">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content transform scale-95 opacity-0">
            <div class="p-6 md:p-8">
            <div class="flex justify-between items-start">
                <h3 id="modal-credential-name" class="text-2xl font-bold text-slate-800"></h3>
                <button id="credential-modal-close-btn" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            <div class="mt-6 border-t pt-6">
                <h4 class="font-semibold text-slate-700 mb-3">Requisitos:</h4>
                <div id="modal-credential-rules" class="space-y-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirm-modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-backdrop">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md modal-content transform scale-95 opacity-0">
        <div class="p-6">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-slate-800">Confirmar reinicio</h3>
            </div>
            <p class="text-slate-600 mb-6">¿Está seguro que desea eliminar todos los cursos aprobados y volver a empezar? Esta acción no se puede deshacer.</p>
            <div class="flex gap-3 justify-end">
                <button id="confirm-cancel" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Cancelar</button>
                <button id="confirm-reset" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">Volver a empezar</button>
            </div>
        </div>
    </div>
</div>

<script>
    const DB = {{ site.data.curriculumdb | jsonify }};
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const state = {
            selectedPlanId: null,
            approvedCourses: new Set(),
            activeTab: 'avance',
            periodFilter: 'all',
            cachedCredentialStatuses: null,
        };

        const ui = {
            planSelect: document.getElementById('plan-select'),
            appBody: document.getElementById('app-body'),
            tabs: document.querySelectorAll('.tab-btn'),
            tabPanes: document.querySelectorAll('.tab-pane'),
            coursesChecklist: document.getElementById('courses-checklist'),
            curriculumMap: document.getElementById('curriculum-map'),
            availableCoursesList: document.getElementById('available-courses-list'),
            periodFilterBtns: document.querySelectorAll('.period-btn'),
            
            stats: {
                approvedCourses: document.getElementById('approved-courses-count'),
                approvedCredits: document.getElementById('approved-credits-count'),
                totalCredits: document.getElementById('total-credits'),
            },
            credentialsProgress: document.getElementById('credentials-progress'),
            
            courseModal: {
                el: document.getElementById('course-modal'),
                name: document.getElementById('modal-course-name'),
                code: document.getElementById('modal-course-code'),
                credits: document.getElementById('modal-course-credits'),
                level: document.getElementById('modal-course-level'),
                categories: document.getElementById('modal-course-categories'),
                availability: document.getElementById('modal-course-availability'),
                prerequisites: document.getElementById('modal-course-prerequisites'),
                unlocks: document.getElementById('modal-course-unlocks'),
                closeBtn: document.getElementById('modal-close-btn'),
            },
            
            credentialModal: {
                el: document.getElementById('credential-modal'),
                name: document.getElementById('modal-credential-name'),
                rules: document.getElementById('modal-credential-rules'),
                closeBtn: document.getElementById('credential-modal-close-btn'),
            },
            
            confirmModal: {
                el: document.getElementById('confirm-modal'),
                cancelBtn: document.getElementById('confirm-cancel'),
                confirmBtn: document.getElementById('confirm-reset'),
            }
        };

        let creditsChart = null;

        function getCourse(code) {
            return DB.courseCatalog[code];
        }

        function getPlan(planId) {
            return DB.programs.find(p => p.id === planId);
        }
        
        function getAllCoursesInPlan(planId) {
            const plan = getPlan(planId);
            if (!plan) return [];
            const courses = new Map();
            plan.blocks.forEach(block => {
                block.courses.forEach(c => {
                    if (!courses.has(c.courseCode)) {
                        courses.set(c.courseCode, getCourse(c.courseCode));
                    }
                });
                if (block.electives) {
                    block.electives.forEach(elective => {
                        // Handle both old categoryRequirements and new courseRequirements structure
                        if (elective.categoryRequirements) {
                            elective.categoryRequirements.forEach(req => {
                                req.availableCourses.forEach(code => {
                                    if (!courses.has(code)) {
                                        courses.set(code, getCourse(code));
                                    }
                                });
                            });
                        }
                        
                        if (elective.courseRequirements) {
                            elective.courseRequirements.forEach(req => {
                                req.availableCourses.forEach(code => {
                                    if (!courses.has(code)) {
                                        courses.set(code, getCourse(code));
                                    }
                                });
                            });
                        }
                    });
                }
            });
            return Array.from(courses.values());
        }

        function getElectiveCoursesGroupedByName(planId) {
            const plan = getPlan(planId);
            if (!plan) return {};
            
            const electivesByName = {};
            
            plan.blocks.forEach(block => {
                if (block.electives) {
                    block.electives.forEach(elective => {
                        if (!electivesByName[elective.name]) {
                            electivesByName[elective.name] = {
                                courses: new Set(),
                                creditsRequired: elective.creditsRequired
                            };
                        }
                        
                        // Handle both old categoryRequirements and new courseRequirements structure
                        if (elective.categoryRequirements) {
                            elective.categoryRequirements.forEach(req => {
                                req.availableCourses.forEach(code => {
                                    const course = getCourse(code);
                                    if (course) {
                                        electivesByName[elective.name].courses.add(course);
                                    }
                                });
                            });
                        }
                        
                        if (elective.courseRequirements) {
                            elective.courseRequirements.forEach(req => {
                                req.availableCourses.forEach(code => {
                                    const course = getCourse(code);
                                    if (course) {
                                        electivesByName[elective.name].courses.add(course);
                                    }
                                });
                            });
                        }
                    });
                }
            });
            
            // Convert Sets to Arrays for easier rendering
            Object.keys(electivesByName).forEach(name => {
                electivesByName[name].courses = Array.from(electivesByName[name].courses);
            });
            
            return electivesByName;
        }

        function calculateTotalPlanCredits(planId) {
            const plan = getPlan(planId);
            if (!plan) return 0;
            
            let totalCredits = 0;
            
            plan.blocks.forEach(block => {
                // Add credits from required courses
                block.courses.forEach(courseInfo => {
                    const course = getCourse(courseInfo.courseCode);
                    if (course) {
                        totalCredits += course.credits;
                    }
                });
                
                // Add credits from electives (only the required amount, not all available courses)
                if (block.electives) {
                    block.electives.forEach(elective => {
                        totalCredits += elective.creditsRequired;
                    });
                }
            });
            
            return totalCredits;
        }

        function saveState() {
            const stateToSave = {
                selectedPlanId: state.selectedPlanId,
                approvedCourses: Array.from(state.approvedCourses)
            };
            localStorage.setItem('academicPlannerState', JSON.stringify(stateToSave));
        }

        function loadState() {
            const savedState = localStorage.getItem('academicPlannerState');
            if (savedState) {
                const parsedState = JSON.parse(savedState);
                state.selectedPlanId = parsedState.selectedPlanId;
                state.approvedCourses = new Set(parsedState.approvedCourses);
            }
        }
        
        function checkPrerequisites(courseCode, planId) {
            const plan = getPlan(planId);
            let prerequisites = null;
            
            for (const block of plan.blocks) {
                const courseInfo = block.courses.find(c => c.courseCode === courseCode);
                if (courseInfo) {
                    prerequisites = courseInfo.prerequisites;
                    break;
                }
            }

            if (!prerequisites || prerequisites.type === 'none') {
                return { met: true, details: [{ text: "Ninguno", met: true }] };
            }

            if (prerequisites.type === 'courses') {
                const details = prerequisites.courses.map(reqCode => {
                    const met = state.approvedCourses.has(reqCode);
                    return { text: `${getCourse(reqCode).name} (${reqCode})`, met };
                });
                return { met: details.every(d => d.met), details };
            }

            if (prerequisites.type === 'blocks') {
                let allCoursesInRequiredBlocks = [];
                prerequisites.blocks.forEach(blockId => {
                    const requiredBlock = plan.blocks.find(b => b.id === blockId);
                    if (requiredBlock) {
                        requiredBlock.courses.forEach(c => allCoursesInRequiredBlocks.push(c.courseCode));
                    }
                });

                const details = allCoursesInRequiredBlocks.map(reqCode => {
                    const met = state.approvedCourses.has(reqCode);
                    return { text: `${getCourse(reqCode).name} (${reqCode})`, met, block: true };
                });

                const met = details.every(d => d.met);
                const summaryDetail = { text: `Todos los cursos de los bloques: ${prerequisites.blocks.join(', ')}`, met };

                return { met, details: [summaryDetail] };
            }

            return { met: false, details: [] };
        }

        function getCourseStatus(courseCode, planId) {
            if (state.approvedCourses.has(courseCode)) {
                return 'approved';
            }
            if (checkPrerequisites(courseCode, planId).met) {
                return 'available';
            }
            return 'locked';
        }

        function checkCredentialStatus(credentialId, allocatedCourses = new Map(), globalCredentialResults = null) {
            const credential = DB.credentials[credentialId];
            if (!credential) return { met: false, progress: 0, details: [], allocatedCourses: new Map() };

            const conditions = credential.rules.conditions;
            let totalConditions = 0;
            let metConditions = 0;
            let totalProgressPoints = 0;
            let earnedProgressPoints = 0;
            const details = [];
            const localAllocatedCourses = new Map(allocatedCourses);

            const check = (conds) => {
                conds.forEach(condition => {
                    totalConditions++;
                    let conditionMet = false;
                    let conditionProgress = 0;
                    let detailText = "";
                    let subDetails = [];

                    if (condition.type === 'courses' && condition.operator === 'all') {
                        let metCount = 0;
                        condition.courses.forEach(c => {
                            if (state.approvedCourses.has(c)) metCount++;
                            subDetails.push({ text: `${getCourse(c).name} (${c})`, met: state.approvedCourses.has(c) });
                        });
                        conditionMet = metCount === condition.courses.length;
                        conditionProgress = condition.courses.length > 0 ? metCount / condition.courses.length : 0;
                        detailText = `Aprobar ${condition.courses.length} cursos específicos (${metCount}/${condition.courses.length})`;
                        
                    } else if (condition.type === 'categories' && condition.operator === 'credits') {
                        // Get available courses (approved and not already allocated)
                        const availableCoursesInCategory = Array.from(state.approvedCourses)
                            .filter(courseCode => !localAllocatedCourses.has(courseCode))
                            .map(getCourse)
                            .filter(c => c.categories.some(cat => condition.categories.includes(cat)));
                        
                        // Sort by credits descending to optimize allocation
                        availableCoursesInCategory.sort((a, b) => b.credits - a.credits);
                        
                        let creditsNeeded = condition.creditsRequired;
                        let allocatedForThisCondition = [];
                        
                        // Allocate courses for this condition
                        for (let course of availableCoursesInCategory) {
                            if (creditsNeeded <= 0) break;
                            allocatedForThisCondition.push(course.code);
                            localAllocatedCourses.set(course.code, credentialId);
                            creditsNeeded -= course.credits;
                        }
                        
                        const creditsEarned = condition.creditsRequired - Math.max(0, creditsNeeded);
                        conditionMet = creditsEarned >= condition.creditsRequired;
                        conditionProgress = condition.creditsRequired > 0 ? Math.min(creditsEarned / condition.creditsRequired, 1) : 0;
                        detailText = `Obtener ${condition.creditsRequired} créditos en ${condition.categories.join('/')} (${creditsEarned}/${condition.creditsRequired})`;
                        
                        // Add subdetails showing which courses were allocated
                        allocatedForThisCondition.forEach(courseCode => {
                            const course = getCourse(courseCode);
                            subDetails.push({ 
                                text: `${course.name} (${courseCode}) - ${course.credits} créditos`, 
                                met: true 
                            });
                        });
                        
                    } else if (condition.type === 'credentials' && condition.operator === 'all') {
                        const dependentCredentialId = condition.credentials[0];
                        let subCredentialStatus;
                        
                        // Always use global results if available to ensure consistency
                        if (globalCredentialResults && globalCredentialResults[dependentCredentialId]) {
                            subCredentialStatus = globalCredentialResults[dependentCredentialId];
                        } else {
                            // For isolated checks or when dependency hasn't been processed yet
                            // Use a fresh allocation context to avoid interference
                            subCredentialStatus = checkCredentialStatus(dependentCredentialId, new Map(), globalCredentialResults);
                        }
                        
                        conditionMet = subCredentialStatus.met;
                        conditionProgress = subCredentialStatus.progress / 100; // Convert to 0-1 scale
                        detailText = `Tener la credencial ${DB.credentials[dependentCredentialId].name}`;
                        subDetails = subCredentialStatus.details;
                        
                    } else if (condition.type === 'courses' && condition.operator === 'credits') {
                        const approvedElectives = Array.from(state.approvedCourses)
                            .filter(c => condition.availableCourses.includes(c));
                        const creditsEarned = approvedElectives.reduce((sum, c) => sum + getCourse(c).credits, 0);
                        conditionMet = creditsEarned >= condition.creditsRequired;
                        conditionProgress = condition.creditsRequired > 0 ? Math.min(creditsEarned / condition.creditsRequired, 1) : 0;
                        detailText = `Obtener ${condition.creditsRequired} créditos de cursos electivos (${creditsEarned}/${condition.creditsRequired})`;
                    }
                    
                    totalProgressPoints += 1;
                    earnedProgressPoints += conditionProgress;
                    
                    if(conditionMet) metConditions++;
                    details.push({ text: detailText, met: conditionMet, subDetails });
                });
            }
            check(conditions);
            
            return {
                met: metConditions === totalConditions,
                progress: totalProgressPoints > 0 ? (earnedProgressPoints / totalProgressPoints) * 100 : 0,
                details,
                allocatedCourses: localAllocatedCourses
            };
        }

        // Global function that manages course allocation across all credentials
        function getAllCredentialStatuses(forceRefresh = false) {
            if (!forceRefresh && state.cachedCredentialStatuses) {
                return state.cachedCredentialStatuses;
            }
            
            const globalAllocatedCourses = new Map();
            const credentialResults = {};
            
            // Process credentials in dependency order (MT1 before MT2, etc.)
            const credentialOrder = ['MT1', 'MT2', 'MT3', 'MT4', 'MT5', 'MT6'];
            
            credentialOrder.forEach(credentialId => {
                if (DB.credentials[credentialId]) {
                    const result = checkCredentialStatus(credentialId, globalAllocatedCourses, credentialResults);
                    credentialResults[credentialId] = result;
                    
                    // Update global allocation map
                    result.allocatedCourses.forEach((credId, courseCode) => {
                        globalAllocatedCourses.set(courseCode, credId);
                    });
                }
            });
            
            state.cachedCredentialStatuses = credentialResults;
            return credentialResults;
        }

        function renderAll() {
            // Clear cached credential statuses when rendering (courses may have changed)
            state.cachedCredentialStatuses = null;
            
            if (!state.selectedPlanId) {
                ui.appBody.classList.add('hidden');
                return;
            }
            ui.appBody.classList.remove('hidden');

            const plan = getPlan(state.selectedPlanId);
            const allCourses = getAllCoursesInPlan(state.selectedPlanId);

            renderStats(allCourses);
            renderCourseChecklist(plan);
            renderCurriculumMap(plan);
            renderAvailableCourses(allCourses);
            renderCredentialsProgress();
            
            saveState();
        }
        
        function renderStats(allCourses) {
            const approvedCoursesObjects = Array.from(state.approvedCourses)
                .map(getCourse)
                .filter(c => c); 
            const approvedCredits = approvedCoursesObjects.reduce((sum, course) => sum + course.credits, 0);
            const totalCredits = calculateTotalPlanCredits(state.selectedPlanId);
            console.log({approvedCredits, totalCredits});

            ui.stats.approvedCourses.textContent = approvedCoursesObjects.length;
            ui.stats.approvedCredits.textContent = approvedCredits;
            ui.stats.totalCredits.textContent = totalCredits;
            
            renderCreditsChart(approvedCredits, totalCredits - approvedCredits);
        }

        function renderCreditsChart(approved, pending) {
            const ctx = document.getElementById('credits-chart').getContext('2d');
            const total = approved + pending;
            const percentage = total > 0 ? Math.round((approved / total) * 100) : 0;
            
            const data = {
                labels: ['Aprobados', 'Pendientes'],
                datasets: [{
                    data: [approved, pending],
                    backgroundColor: ['#22c55e', '#e2e8f0'],
                    borderColor: ['#ffffff', '#ffffff'],
                    borderWidth: 2,
                }]
            };
            if (creditsChart) {
                creditsChart.data = data;
                creditsChart.options.plugins.centerText = { percentage };
                creditsChart.update();
            } else {
                creditsChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.raw} créditos`;
                                    }
                                }
                            },
                            centerText: { percentage }
                        }
                    },
                    plugins: [{
                        id: 'centerText',
                        beforeDraw: function(chart) {
                            const width = chart.width;
                            const height = chart.height;
                            const ctx = chart.ctx;
                            
                            ctx.save();
                            const fontSize = Math.min(width, height) / 8;
                            ctx.font = `bold ${fontSize}px Inter, sans-serif`;
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillStyle = '#1e293b';
                            
                            const currentPercentage = chart.options.plugins.centerText?.percentage || 0;
                            const text = `${currentPercentage}%`;
                            
                            ctx.fillText(text, width / 2, height / 2);
                            ctx.restore();
                        }
                    }]
                });
            }
        }
        
        function renderCourseChecklist(plan) {
            let html = '';
            
            // Render regular course blocks
            plan.blocks.forEach(block => {
                html += `<div class="p-4 border border-slate-200 rounded-lg">
                            <h4 class="text-lg font-semibold text-slate-700 mb-3">${block.name}</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">`;
                block.courses.forEach(courseInfo => {
                    const course = getCourse(courseInfo.courseCode);
                    const isChecked = state.approvedCourses.has(course.code);
                    html += `<label class="flex items-center space-x-3 p-2 rounded-md hover:bg-slate-50 transition">
                                <input type="checkbox" data-course-code="${course.code}" class="h-5 w-5 rounded border-gray-300 text-amber-600 focus:ring-amber-500" ${isChecked ? 'checked' : ''}>
                                <span>${course.name} (${course.code})</span>
                            </label>`;
                });
                html += `</div></div>`;
            });
            
            // Render elective courses pseudoblock
            const electivesByName = getElectiveCoursesGroupedByName(state.selectedPlanId);
            if (Object.keys(electivesByName).length > 0) {
                html += `<div class="p-4 border border-amber-200 rounded-lg bg-amber-50">
                            <h4 class="text-lg font-semibold text-amber-800 mb-3">Cursos Electivos</h4>`;
                
                Object.entries(electivesByName).forEach(([electiveName, electiveData]) => {
                    if (electiveData.courses.length > 0) {
                        html += `<div class="mb-4">
                                    <h5 class="text-md font-medium text-slate-700 mb-2">${electiveName} 
                                        <span class="text-sm font-normal text-slate-500">(${electiveData.creditsRequired} créditos requeridos)</span>
                                    </h5>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">`;
                        
                        electiveData.courses.forEach(course => {
                            const isChecked = state.approvedCourses.has(course.code);
                            html += `<label class="flex items-center space-x-3 p-2 rounded-md hover:bg-amber-100 transition">
                                        <input type="checkbox" data-course-code="${course.code}" class="h-5 w-5 rounded border-gray-300 text-amber-600 focus:ring-amber-500" ${isChecked ? 'checked' : ''}>
                                        <span>${course.name} (${course.code})</span>
                                    </label>`;
                        });
                        html += `</div></div>`;
                    }
                });
                html += `</div>`;
            }
            
            ui.coursesChecklist.innerHTML = html;
        }

        function renderCurriculumMap(plan) {
            let html = '';
            plan.blocks.forEach(block => {
                    html += `<div class="p-4 border border-slate-200 rounded-lg">
                            <h4 class="text-lg font-semibold text-slate-700 mb-4">${block.name}</h4>
                            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">`;
                block.courses.forEach(courseInfo => {
                    const course = getCourse(courseInfo.courseCode);
                    const status = getCourseStatus(course.code, state.selectedPlanId);
                    const colorClass = {
                        approved: 'bg-green-500 hover:bg-green-600',
                        available: 'bg-blue-500 hover:bg-blue-600',
                        locked: 'bg-slate-500 hover:bg-slate-600'
                    }[status];
                    
                    html += `<div data-course-code="${course.code}" class="course-card cursor-pointer p-3 rounded-lg text-white ${colorClass}">
                                <p class="font-semibold text-sm">${course.name}</p>
                                <p class="text-xs opacity-80">${course.code}</p>
                            </div>`;
                });
                html += `</div></div>`;
            });
            ui.curriculumMap.innerHTML = html;
        }

        function isElectiveGroupSatisfied(planId, blockId, electiveName) {
            const plan = getPlan(planId);
            const block = plan.blocks.find(b => b.id === blockId);
            if (!block || !block.electives) return false;
            
            const elective = block.electives.find(e => e.name === electiveName);
            if (!elective) return false;
            
            let approvedCredits = 0;
            
            // Check categoryRequirements
            if (elective.categoryRequirements) {
                elective.categoryRequirements.forEach(catReq => {
                    const approvedInCategory = Array.from(state.approvedCourses)
                        .map(getCourse)
                        .filter(course => 
                            catReq.availableCourses.includes(course.code) &&
                            course.categories.some(cat => catReq.categories.includes(cat))
                        );
                    approvedCredits += approvedInCategory.reduce((sum, c) => sum + c.credits, 0);
                });
            }
            
            // Check courseRequirements
            if (elective.courseRequirements) {
                elective.courseRequirements.forEach(courseReq => {
                    const approvedElectiveCourses = Array.from(state.approvedCourses)
                        .filter(courseCode => courseReq.availableCourses.includes(courseCode));
                    approvedCredits += approvedElectiveCourses.reduce((sum, code) => sum + getCourse(code).credits, 0);
                });
            }
            
            return approvedCredits >= elective.creditsRequired;
        }

        function getCourseElectiveInfo(courseCode, planId) {
            const plan = getPlan(planId);
            for (const block of plan.blocks) {
                if (!block.electives) continue;
                
                for (const elective of block.electives) {
                    // Check if course is in categoryRequirements
                    if (elective.categoryRequirements) {
                        for (const catReq of elective.categoryRequirements) {
                            if (catReq.availableCourses && catReq.availableCourses.includes(courseCode)) {
                                return {
                                    blockId: block.id,
                                    electiveName: elective.name,
                                    isElective: true
                                };
                            }
                        }
                    }
                    
                    // Check if course is in courseRequirements
                    if (elective.courseRequirements) {
                        for (const courseReq of elective.courseRequirements) {
                            if (courseReq.availableCourses && courseReq.availableCourses.includes(courseCode)) {
                                return {
                                    blockId: block.id,
                                    electiveName: elective.name,
                                    isElective: true
                                };
                            }
                        }
                    }
                }
            }
            return { isElective: false };
        }

        function renderAvailableCourses(allCourses) {
            const availableCourses = allCourses.filter(course => {
                const status = getCourseStatus(course.code, state.selectedPlanId);
                if (status !== 'available') return false;
                
                // Check if this is an elective course and if its group is already satisfied
                const electiveInfo = getCourseElectiveInfo(course.code, state.selectedPlanId);
                if (electiveInfo.isElective) {
                    // If the elective group is already satisfied, don't show this course
                    return !isElectiveGroupSatisfied(state.selectedPlanId, electiveInfo.blockId, electiveInfo.electiveName);
                }
                
                return true;
            });

                const periodMap = { q1: 'quarters', q2: 'quarters', q3: 'quarters', s1: 'semesters', s2: 'semesters' };
                const periodNum = { q1: 1, q2: 2, q3: 3, s1: 1, s2: 2 };

                const filteredCourses = state.periodFilter === 'all' 
                ? availableCourses
                : availableCourses.filter(course => {
                    const availability = course.availability;
                    const periodType = periodMap[state.periodFilter];
                    return availability[periodType] && availability[periodType].includes(periodNum[state.periodFilter]);
                });
            
            let html = '';
            if (filteredCourses.length === 0) {
                html = `<p class="text-slate-500 col-span-full">No hay cursos disponibles que coincidan con sus filtros. Intente seleccionar "Todos" o verifique su avance.</p>`;
            } else {
                filteredCourses.forEach(course => {
                    html += `<div data-course-code="${course.code}" class="course-card cursor-pointer p-4 rounded-lg border border-slate-200 bg-white hover:border-amber-500">
                                <p class="font-semibold text-slate-800">${course.name}</p>
                                <p class="text-sm text-slate-500">${course.code}</p>
                                <div class="text-xs mt-2 text-slate-600">
                                    ${getAvailabilityText(course.availability, true)}
                                </div>
                            </div>`;
                });
            }
            ui.availableCoursesList.innerHTML = html;
        }

        function renderCredentialsProgress() {
            let html = '';
            const allCredentialStatuses = getAllCredentialStatuses();
            
            Object.keys(DB.credentials).forEach(credId => {
                const status = allCredentialStatuses[credId] || checkCredentialStatus(credId, new Map(), allCredentialStatuses);
                const credential = DB.credentials[credId];
                html += `
                    <div data-credential-id="${credId}" class="credential-item cursor-pointer">
                        <div class="flex justify-between mb-1">
                            <span class="text-base font-medium text-slate-700">${credential.name}</span>
                            <span class="text-sm font-medium ${status.met ? 'text-green-600' : 'text-slate-500'}">${status.met ? 'Completado' : `${Math.round(status.progress)}%`}</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div class="bg-${status.met ? 'green' : 'amber'}-500 h-2.5 rounded-full progress-bar-fill" style="width: ${status.progress}%"></div>
                        </div>
                    </div>`;
            });
            ui.credentialsProgress.innerHTML = html;
        }

        function openCourseModal(courseCode) {
            const course = getCourse(courseCode);
            const prerequisites = checkPrerequisites(course.code, state.selectedPlanId);
            const allCoursesInPlan = getAllCoursesInPlan(state.selectedPlanId);
            const unlocks = allCoursesInPlan.filter(c => {
                let prereqsForC = null;
                    getPlan(state.selectedPlanId).blocks.forEach(block => {
                    const courseInfo = block.courses.find(ci => ci.courseCode === c.code);
                    if (courseInfo) prereqsForC = courseInfo.prerequisites;
                });
                return prereqsForC && prereqsForC.type === 'courses' && prereqsForC.courses.includes(course.code);
            });

            ui.courseModal.name.textContent = course.name;
            ui.courseModal.code.textContent = course.code;
            ui.courseModal.credits.textContent = course.credits;
            ui.courseModal.level.textContent = course.level;
            ui.courseModal.categories.textContent = course.categories.join(', ');
            ui.courseModal.availability.textContent = getAvailabilityText(course.availability);
            
            ui.courseModal.prerequisites.innerHTML = prerequisites.details.length > 0
                ? prerequisites.details.map(p => `<li class="${p.met ? 'text-green-600' : 'text-red-600'}">${p.text}</li>`).join('')
                : '<li>Ninguno</li>';

            ui.courseModal.unlocks.innerHTML = unlocks.length > 0
                ? unlocks.map(c => `<li>${c.name} (${c.code})</li>`).join('')
                : '<li>No desbloquea cursos directamente.</li>';

            ui.courseModal.el.classList.remove('hidden');
            setTimeout(() => {
                ui.courseModal.el.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
                ui.courseModal.el.classList.remove('opacity-0');
            }, 10);
        }
        
        function closeCourseModal() {
            ui.courseModal.el.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
            ui.courseModal.el.classList.add('opacity-0');
            setTimeout(() => ui.courseModal.el.classList.add('hidden'), 300);
        }
        
        function openCredentialModal(credentialId) {
            const credential = DB.credentials[credentialId];
            const allStatuses = getAllCredentialStatuses();
            const status = allStatuses[credentialId] || checkCredentialStatus(credentialId, new Map(), allStatuses);

            ui.credentialModal.name.textContent = `${credential.name} - Detalles`;
            let rulesHtml = '';
            status.details.forEach(detail => {
                const icon = detail.met ? '<span class="text-green-500 mr-2">&#10003;</span>' : '<span class="text-red-500 mr-2">&#10007;</span>';
                rulesHtml += `<div>${icon}${detail.text}</div>`;
                if (detail.subDetails && detail.subDetails.length > 0) {
                    rulesHtml += `<ul class="list-disc list-inside pl-6 text-sm text-slate-600">`;
                    detail.subDetails.forEach(sub => {
                        const subIcon = sub.met ? 'text-green-500' : 'text-red-500';
                        rulesHtml += `<li class="${subIcon}">${sub.text}</li>`;
                    });
                    rulesHtml += `</ul>`;
                }
            });

            ui.credentialModal.rules.innerHTML = rulesHtml;
            ui.credentialModal.el.classList.remove('hidden');
            setTimeout(() => {
                ui.credentialModal.el.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
                ui.credentialModal.el.classList.remove('opacity-0');
            }, 10);
        }

        function closeCredentialModal() {
            ui.credentialModal.el.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
            ui.credentialModal.el.classList.add('opacity-0');
            setTimeout(() => ui.credentialModal.el.classList.add('hidden'), 300);
        }

        function openConfirmModal() {
            ui.confirmModal.el.classList.remove('hidden');
            ui.confirmModal.el.classList.remove('opacity-0');
            setTimeout(() => {
                ui.confirmModal.el.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
                ui.confirmModal.el.classList.remove('opacity-0');
            }, 10);
        }

        function closeConfirmModal() {
            ui.confirmModal.el.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
            ui.confirmModal.el.classList.add('opacity-0');
            setTimeout(() => ui.confirmModal.el.classList.add('hidden'), 300);
        }

        function getAvailabilityText(availability, compact = false) {
            let text = [];
            if (availability.quarters) text.push(`${compact ? 'Cuatris' : 'Cuatrimestres'}: ${availability.quarters.join(', ')}`);
            if (availability.semesters) text.push(`${compact ? 'Sems' : 'Semestres'}: ${availability.semesters.join(', ')}`);
            return text.join(' | ');
        }

        function handlePlanChange(e) {
            state.selectedPlanId = e.target.value;
            state.approvedCourses.clear(); 
            renderAll();
        }

        function handleCourseCheck(e) {
            if (e.target.type === 'checkbox') {
                const courseCode = e.target.dataset.courseCode;
                if (e.target.checked) {
                    state.approvedCourses.add(courseCode);
                } else {
                    state.approvedCourses.delete(courseCode);
                }
                renderAll();
            }
        }

        function handleTabClick(e) {
            const tab = e.target.closest('.tab-btn');
            if (!tab) return;
            
            state.activeTab = tab.dataset.tab;

            ui.tabs.forEach(t => t.classList.remove('tab-active'));
            tab.classList.add('tab-active');

            ui.tabPanes.forEach(p => p.classList.add('hidden'));
            document.getElementById(`${state.activeTab}-tab`).classList.remove('hidden');
        }
        
        function handlePeriodFilterClick(e) {
            const btn = e.target.closest('.period-btn');
            if (!btn) return;

            state.periodFilter = btn.dataset.period;
            
            ui.periodFilterBtns.forEach(b => b.classList.replace('bg-amber-500', 'bg-slate-200') || b.classList.replace('text-white', 'text-slate-700'));
            btn.classList.replace('bg-slate-200', 'bg-amber-500');
            btn.classList.replace('text-slate-700', 'text-white');

            renderAll();
        }

        function clearAllCourses() {
            openConfirmModal();
        }

        function confirmReset() {
            state.approvedCourses.clear();
            renderAll();
            closeConfirmModal();
        }

        function init() {
            loadState();

            DB.programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program.id;
                option.textContent = `${program.name} (${program.degree})`;
                ui.planSelect.appendChild(option);
            });

            if (state.selectedPlanId) {
                ui.planSelect.value = state.selectedPlanId;
            } else {
                state.selectedPlanId = DB.programs[0].id;
                ui.planSelect.value = state.selectedPlanId;
            }

            ui.planSelect.addEventListener('change', handlePlanChange);
            ui.coursesChecklist.addEventListener('change', handleCourseCheck);
            ui.appBody.addEventListener('click', handleTabClick);
            ui.periodFilterBtns.forEach(btn => btn.addEventListener('click', handlePeriodFilterClick));
            
            document.body.addEventListener('click', (e) => {
                const courseCard = e.target.closest('.course-card');
                if(courseCard) openCourseModal(courseCard.dataset.courseCode);

                const credentialItem = e.target.closest('.credential-item');
                if(credentialItem) openCredentialModal(credentialItem.dataset.credentialId);
            });
            
            ui.courseModal.closeBtn.addEventListener('click', closeCourseModal);
            ui.courseModal.el.addEventListener('click', (e) => { if(e.target === ui.courseModal.el) closeCourseModal()});
            
            ui.credentialModal.closeBtn.addEventListener('click', closeCredentialModal);
            ui.credentialModal.el.addEventListener('click', (e) => { if(e.target === ui.credentialModal.el) closeCredentialModal()});
            
            ui.confirmModal.cancelBtn.addEventListener('click', closeConfirmModal);
            ui.confirmModal.confirmBtn.addEventListener('click', confirmReset);
            ui.confirmModal.el.addEventListener('click', (e) => { if(e.target === ui.confirmModal.el) closeConfirmModal()});

            renderAll();
            
            // Add reset button event listener after rendering
            const resetButton = document.getElementById('reset-button');
            if (resetButton) {
                resetButton.addEventListener('click', clearAllCourses);
            }
        }

        init();
    });
</script>
